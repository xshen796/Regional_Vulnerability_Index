* * *
### Contact and credit

X Shen (xueyi.shen@ed.ac.uk, emails replied on Wednesdays and Fridays)

Reference: https://ajp.psychiatryonline.org/doi/pdf/10.1176/appi.ajp.2019.18101212

* * *
### R settings

Required packages: dplyr, pbapply

Source file: create_RVI.R

```{r}
library(dplyr)
library(pbapply)
library(knitr)
```


* * *
### Summary

This is an example script for creating RVI using stradl MD(mean diffusivity) data

Reference beta came from the [ENIGMA paper](https://www.nature.com/articles/s41380-019-0477-2)(2020).

Reference beta downloaded from [Table S5](https://static-content.springer.com/esm/art%3A10.1038%2Fs41380-019-0477-2/MediaObjects/41380_2019_477_MOESM2_ESM.docx).


* * *
### Prepare inputs

##### Load MD data

```{r}
stradl.dti.MD=read.csv('/exports/igmm/eddie/GenScotDepression/shen/bakup.dat/stradl_imaging/DTI/STRADL_Measures_DTI_MD.csv',header=T,stringsAsFactors=F)

# Select columns that match the reference beta data
stradl.dti.MD <- stradl.dti.MD %>%
                 (function(x) x[,!grepl('\\.L$|\\.R$',colnames(x))])

colnames(stradl.dti.MD)=gsub('AverageFA','AverageMD',colnames(stradl.dti.MD))

# Add covariates
control.id=readRDS('../data/identify_controlsample.rds')
linkage.dat=readRDS('/exports/igmm/eddie/GenScotDepression/shen/bakup.dat/stradl_imaging/DataLinkage/Methylation_Genotype_Imaging_linkageID.rds')
control.id = merge(control.id,linkage.dat,by.x='ID',by.y='genotype_ID',all.y=T)

stradl.dti.MD=merge(stradl.dti.MD,control.id[,c('stradl_ID','sex','age')],by.x='subjectID',by.y='stradl_ID',all.x=T)

head(stradl.dti.MD)
```


##### Specify covariates

```{r}
ls.covs.stradl=c('age','sex')

```


##### Specify healthy controls (free from any psychiatric condition)
```{r}
ls.control.ID.stradl = control.id$stradl_ID[control.id$is_control]
head(ls.control.ID.stradl)
```

##### Reference data (ENIGMA beta)
```{r}
beta.MD.enigma=read.delim('../data/ENIGMA_effectsizes_MD.txt',header=F,stringsAsFactors=F)
head(beta.MD.enigma)
```

* * *
### Source create_RVI function
```{r}
source('create_RVI.R')
```


* * *
### Run create_RVI function
```{r}
RVI.stradl.MD=create_RVI(x=stradl.dti.MD,
                         ls.covs=ls.covs.stradl,
                         ls.control.ID=ls.control.ID.stradl,
                         ref.beta=beta.MD.enigma)
```

The output will look like:
```{r}
head(RVI.stradl.MD)
```

