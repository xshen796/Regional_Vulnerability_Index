# x: dataframe of individual brain measures, first column should be IDs
# ls.covs: a vector of column names in x that should be covariates
# ls.control.ID: a vector of subj IDs for healthy controls
# ref.beta: reference beta from an independent sample


# Load libraries
library(dplyr)
library(pbapply)


# Functions used for create_RVI   ------------------------------------------------------------------------
      
# Function for residualise multiple brain measures
residualise_dat <- function(col.input,dat) {
    coln=as.character(col.input[1])
    cov=as.character(col.input[2])
    colnames(dat)[1]='ID'

    eq=paste0(coln,'~',cov)
    fit=glm(as.formula(eq),dat=dat)
    new.dat=resid(fit)
    ls.cov=strsplit(cov,'\\+') %>% unlist
    new.dat=data.frame(ID=dat[complete.cases(dat[,c(coln,ls.cov)]),1],pheno=new.dat,stringsAsFactors=F)
    
    original.ID=data.frame(ID=dat$ID,stringsAsFactors=F)
    new.dat=merge(original.ID,new.dat,by='ID',all.x=T)
    
    output=data.frame(pheno=new.dat$pheno,stringsAsFactors=F)
    colnames(output)=coln
    return(output)
}
 
RVI_step1 <- function(xcol,dat){
      tmp.dat=dat[,xcol]
      tmp.mean=mean(tmp.dat[dat$ID %in% ls.control.ID],na.rm=T)
      tmp.sd=sd(tmp.dat[dat$ID %in% ls.control.ID],na.rm=T)
      new.RVI.step1=data.frame((tmp.dat-tmp.mean)/tmp.sd)
      colnames(new.RVI.step1)=xcol
      return(new.RVI.step1)
}

RVI_step2 <- function(ref.dat,target.dat){
      tmp.dat=merge(ref.dat,target.dat,by='region') %>% select(-region)
      tmp.cormat=cor(tmp.dat)
      new.RVI.step2=tmp.cormat[1,2:ncol(tmp.cormat)]
      tmp.ID = colnames(target.dat %>% select(-region))
      output=data.frame(ID=tmp.ID,RVI=new.RVI.step2,stringsAsFactors=F)
      rownames(output)=NULL
      return(output)
}


# Main function body   -------------------------------------------------------------------------------------

create_RVI <- function(x,ls.covs,ls.control.ID,ref.beta,resid_process=T){
      
      colnames(x)[1]='ID'
      colnames(ref.beta)=c('region','beta')
      if(sum(!ref.beta[,1] %in% colnames(x))>0){stop('All tract names in ref.beta must be found in x')}

      ### Corrrect for confounding effects
      if (resid_process==T){
        input.for_resid = data.frame(pheno=ref.beta$region,
                                  covs=paste0(ls.covs,collapse='+'),
                                  stringsAsFactors=F)
        print('Correct for confounders')
        tmp.dat.aftercorr <- pbapply(input.for_resid,1,residualise_dat,dat=x) %>% # A list created by residualise_dat
                             bind_cols %>%  # Convert into a dataframe
                             mutate(.,ID=x$ID) %>% # Add ID
                             select('ID', everything()) # Move ID to the first column
             
      }else{
        tmp.dat.aftercorr = x[,c('ID',ref.beta$region)]     
      }

      ### RVI step 1

      # Run step 1
      ls.cols.forRVI1=as.list(ref.beta$region)
      print('RVI step 1')
      RVI_1 <- pblapply(ls.cols.forRVI1,RVI_step1,dat=tmp.dat.forRVI1) %>% 
                    bind_cols 
      rownames(RVI_1)=tmp.dat.forRVI1$ID 
                    
      ### RVI step 2
      # Convert RVI_1 (one subj one col, add a column called region matching the reference data)
      tmp.dat.forRVI2 <- t(RVI_1) %>%
                         as.data.frame %>%
                         mutate(.,region=rownames(.)) # Add region
                 
      # Run RVI step 2              
      print('RVI step 2')
      RVI_score=RVI_step2(ref.beta,tmp.dat.forRVI2)
      
      glimpse(RVI_score)
      return(RVI_score)
}